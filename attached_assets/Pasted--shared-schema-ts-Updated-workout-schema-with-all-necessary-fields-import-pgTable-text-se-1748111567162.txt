// shared/schema.ts - Updated workout schema with all necessary fields

import { pgTable, text, serial, timestamp, integer, jsonb, boolean } from 'drizzle-orm/pg-core';

export const workouts = pgTable('workouts', {
  id: serial('id').primaryKey(),
  userId: text('user_id').notNull(),
  name: text('name').notNull(),
  description: text('description'),
  duration: integer('duration').notNull(), // in minutes
  difficulty: text('difficulty').notNull(), // beginner, intermediate, advanced
  
  // Auto-save specific fields
  createdBy: text('created_by').default('user'), // 'user' or 'ai-agent'
  autoGenerated: boolean('auto_generated').default(false),
  
  // Rich metadata as JSONB
  metadata: jsonb('metadata').default({
    generationParams: {},
    exercises: {
      warmup: [],
      main: [],
      cooldown: []
    },
    version: '1.0',
    aiModel: null
  }),
  
  // Categorization
  tags: text('tags').array().default([]),
  estimatedCalories: integer('estimated_calories'),
  targetMuscleGroups: text('target_muscle_groups').array().default([]),
  
  // Analytics
  analytics: jsonb('analytics').default({
    timesCompleted: 0,
    lastCompleted: null,
    averageRating: null,
    feedback: []
  }),
  
  // Timestamps
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow()  
});

export type Workout = typeof workouts.$inferSelect;
export type NewWorkout = typeof workouts.$inferInsert;

// If you need to migrate existing data, here's the migration SQL:
export const migrationSQL = `
-- Add new columns to existing workouts table
ALTER TABLE workouts 
ADD COLUMN IF NOT EXISTS created_by TEXT DEFAULT 'user',
ADD COLUMN IF NOT EXISTS auto_generated BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS metadata JSONB DEFAULT '{}',
ADD COLUMN IF NOT EXISTS tags TEXT[] DEFAULT '{}',
ADD COLUMN IF NOT EXISTS estimated_calories INTEGER,
ADD COLUMN IF NOT EXISTS target_muscle_groups TEXT[] DEFAULT '{}',
ADD COLUMN IF NOT EXISTS analytics JSONB DEFAULT '{"timesCompleted": 0, "lastCompleted": null, "averageRating": null, "feedback": []}';

-- Update existing workouts to have proper metadata structure
UPDATE workouts 
SET metadata = jsonb_build_object(
  'generationParams', '{}',
  'exercises', jsonb_build_object(
    'warmup', '[]',
    'main', '[]', 
    'cooldown', '[]'
  ),
  'version', '1.0',
  'aiModel', null
)
WHERE metadata IS NULL OR metadata = '{}';
`;